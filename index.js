const TelegramBot = require('node-telegram-bot-api')

const token = 'TOKEN'

const adminChatId = '5135938899';

const bot = new TelegramBot(token, { polling: true });

bot.setMyCommands([
    {command: '/start', description: '–ù–∞—á–∞—Ç—å —Å –Ω–∞—á–∞–ª–∞'}
])

const allowedButtonLabels = ['–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å', '–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é'];

const userState = new Map();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    
    const welcomeMessage = `
    –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –≤–∞—Å –≤ —á–∞—Ç –±–æ—Ç–µ "–ö—Ä—ã–º—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è"! 
    –≤—ã–≤—ã–≤—ã
    –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ –ø–æ–º–æ—â—å—é –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É. –ü—Ä–æ—Å—Ç–æ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä–∞—è –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç. –ú—ã –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –≤–∞–º!
    `;

    const options = {
        reply_markup: {
            keyboard: [
                allowedButtonLabels.map((label) => ({ text: label })),
                ],
            resize_keyboard:  false,
            one_time_keyboard: true, // –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞, –∏—Å—á–µ–∑–∞–µ—Ç –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        }
    };
                
    bot.sendMessage(chatId, welcomeMessage, options);
    bot.sendMessage({ caption: `–ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö –¥–µ–ª –£–∫—Ä–∞–∏–Ω—ã –æ—Ç–º–µ—á–∞–µ—Ç, —á—Ç–æ –ø–æ—Å–ª–µ –Ω–∞–ø–∞–¥–µ–Ω–∏—è –†–§ –Ω–∞ –£–∫—Ä–∞–∏–Ω—É –ø—Ä–µ–∫—Ä–∞—Ç–∏–ª–∞—Å—å —Ä–∞–±–æ—Ç–∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–æ–ª—å—Å—Ç–≤–∞, –Ω–æ –∏ –≤—Å–µ—Ö –∫–æ–Ω—Å—É–ª—å—Å—Ç–≤.

    –û–± —ç—Ç–æ–º –≥–æ–≤–æ—Ä–∏—Ç—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ú–ò–î –¥–ª—è –Ω–∞—Ö–æ–¥—è—â–∏—Ö—Å—è –≤ –†–§ –≥—Ä–∞–∂–¥–∞–Ω –£–∫—Ä–∞–∏–Ω—ã.

    –î–∏–ø–≤–µ–¥–æ–º—Å—Ç–≤–æ –Ω–∞–ø–æ–º–Ω–∏–ª–æ, —á—Ç–æ –≤ —Å–≤—è–∑–∏ —Å –≤–æ–æ—Ä—É–∂–µ–Ω–Ω–æ–π –∞–≥—Ä–µ—Å—Å–∏–µ–π –∏ –º–∞—Å—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤—Ç–æ—Ä–∂–µ–Ω–∏–µ–º –≤–æ–æ—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–∏–ª –†–§ –≤ –£–∫—Ä–∞–∏–Ω—É 24 —Ñ–µ–≤—Ä–∞–ª—è 2022 –±—ã–ª–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —Ä–∞–∑–æ—Ä–≤–∞–Ω—ã –¥–∏–ø–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –£–∫—Ä–∞–∏–Ω–æ–π –∏ –†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–µ–π. –ü–æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º—É –ø—Ä–∞–≤—É —ç—Ç–æ –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è —Ç–∞–∫–∂–µ –∫–æ–Ω—Å—É–ª—å—Å–∫–∏—Ö —Å–Ω–æ—à–µ–Ω–∏–π, –æ–¥–Ω–∞–∫–æ –∏ –æ–Ω–∏ –¥–µ-—Ñ–∞–∫—Ç–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å.

    "–ü–æ—Å–æ–ª—å—Å—Ç–≤–æ –£–∫—Ä–∞–∏–Ω—ã –≤ –ú–æ—Å–∫–≤–µ –∏ –∫–æ–Ω—Å—É–ª—å—Å–∫–∏–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è –£–∫—Ä–∞–∏–Ω—ã –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –†–§ –±—ã–ª–∏ –≤—ã–Ω—É–∂–¥–µ–Ω—ã –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–≤–æ–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π", - –≥–æ–≤–æ—Ä–∏—Ç—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏.

    –ú–ò–î —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –≥—Ä–∞–∂–¥–∞–Ω–∞–º–∏ –£–∫—Ä–∞–∏–Ω—ã, –≤ —Å–ª—É—á–∞–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –Ω–µ–æ—Ç–ª–æ–∂–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Å–∫–æ–π –ø–æ–º–æ—â–∏, –æ–±—Ä–∞—â–∞—Ç—å—Å—è –Ω–∞ "–≥–æ—Ä—è—á—É—é –ª–∏–Ω–∏—é" –ú–ò–î –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É (+38044 2381588) –∏–ª–∏ –Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –ø–æ—á—Ç—É mfa.hotline.cons@gmail.com.` 
    });

    userState.set(chatId, '–æ–∂–∏–¥–∞–Ω–∏–µ_–∫–Ω–æ–ø–æ–∫');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å"
bot.onText(/–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å/, (msg) => {
    const chatId = msg.chat.id;
    const adminMessage = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${msg.from.first_name} (${msg.from.username || '–±–µ–∑ –∏–º–µ–Ω–∏'}) —Ö–æ—á–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å.`;
    
    const options = {
        reply_markup: {
            remove_keyboard: false,
        }
    };
    
    bot.sendMessage(chatId, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ:', options);
    
    bot.once('message', async (userMsg) => {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –ø–æ–ª—É—á–µ–Ω–∏–∏
        bot.sendMessage(chatId, '–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ. –û–∂–∏–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.');
        
        // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        await bot.forwardMessage(adminChatId, chatId, userMsg.message_id);
    });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"
bot.onText(/–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é/, async (msg) => {
    const chatId = msg.chat.id;
    const adminMessage = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${msg.from.first_name} https://t.me/${msg.from.username || '–±–µ–∑ –∏–º–µ–Ω–∏'} —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.`;

    const inlineKeyboard = {
        inline_keyboard: [
            [
                { text: '–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å', url: 'https://t.me/crimean_diskurs', callback_data: 'button1' },
            ]
        ],
    };

    const options = {
        reply_markup: {
            remove_keyboard: false,
        }
    };
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
    bot.sendMessage(chatId, '–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å? –ó–∞–¥–∞–π—Ç–µ –µ–≥–æ –Ω–∞–º ‚¨áÔ∏è', {reply_markup: inlineKeyboard}, options);
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    await bot.sendMessage(adminChatId, adminMessage);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫

bot.on('message', (msg) => {
    const text = msg.text;

    if (text === '/start') {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –∫–æ–º–∞–Ω–¥—É /start, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç–∞
        return;
    }
});

bot.onText(/^(?!\/).+/, (msg) => {
    const chatId = msg.chat.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const state = userState.get(chatId);
    
    if (state === '–æ–∂–∏–¥–∞–Ω–∏–µ_–∫–Ω–æ–ø–æ–∫') {
        // –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∫–Ω–æ–ø–æ–∫
        bot.sendMessage(chatId, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.');
    }
});
// bot.onText(/[^\/start].+/, (msg) => {
//     const chatId = msg.chat.id;
//     bot.sendMessage(chatId, '–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –ø–æ–Ω–∏–º–∞—é –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –í–≤–µ–¥–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞, –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∏–∂–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã üîΩ');
// });

bot.on('polling_error', (error) => {
    console.error(error); // –í—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å
}); 